<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exporter Profile</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .form-section { margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
    .form-section h2 { font-size: 1.2em; margin-bottom: 10px; }
    label { display: block; margin: 5px 0 2px; }
    input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
    .inline-group { display: flex; gap: 10px; }
    .inline-group > div { flex: 1; }
    .hidden { display: none; }
    .block { border: 1px dashed #888; padding: 10px; margin-bottom: 10px; position: relative; }
    .remove-btn { position: absolute; top: 10px; right: 10px; cursor: pointer; color: red; }
    .add-btn { margin: 10px 0; }
    .dynamic-params { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Exporter Profile Form</h1>

  <!-- 1. Company Information -->
  <div class="form-section">
    <h2>1. Company Information</h2>
    <label>Company Name</label><input type="text" name="companyName" required />
    <label>Tax ID</label><input type="text" name="taxId" required />
    <label>VAT ID</label><input type="text" name="vatId" required />
    <label>Headquarters Address</label><textarea name="hqAddress" required></textarea>
    <h3>Additional Sites</h3>
    <button type="button" class="add-btn" onclick="addSite()">+ Add Site</button>
    <div id="sitesContainer"></div>
    <div class="inline-group">
      <div><label>Phone</label><input type="tel" name="phone" required /></div>
      <div><label>Fax</label><input type="tel" name="fax" /></div>
    </div>
    <label>Website</label><input type="url" name="website" />
    <h3>Key Contacts</h3>
    <label>CEO/GM Name</label><input type="text" name="ceoName" required />
    <label>CEO/GM Email</label><input type="email" name="ceoEmail" required />
    <label>CEO/GM Phone</label><input type="tel" name="ceoPhone" required />
    <label>Quality Manager Name</label><input type="text" name="qualityManagerName" required />
    <label>Quality Manager Email</label><input type="email" name="qualityManagerEmail" required />
    <label>Quality Manager Phone</label><input type="tel" name="qualityManagerPhone" required />
    <label>Export Manager Name</label><input type="text" name="exportManagerName" required />
    <label>Export Manager Email</label><input type="email" name="exportManagerEmail" required />
    <label>Export Manager Phone</label><input type="tel" name="exportManagerPhone" required />
  </div>

  <!-- 2. Product Details -->
  <div class="form-section">
    <h2>2. Product Details</h2>
    <button type="button" class="add-btn" onclick="addProduct()">+ Add Product</button>
    <div id="productsContainer"></div>
  </div>

  <!-- 3. Packaging Options -->
  <div class="form-section">
    <h2>3. Packaging Options</h2>
    <div class="inline-group">
      <div><label>Format</label><select name="packageType"><option>Bulk</option><option>Drum</option><option>Retail</option></select></div>
      <div><label>Unit Size</label><input type="text" name="unitSize" /></div>
    </div>
  </div>

  <!-- 4. Certifications & Compliance -->
  <div class="form-section">
    <h2>4. Certifications & Compliance</h2>
    <button type="button" class="add-btn" onclick="addCert()">+ Add Certification</button>
    <div id="certsContainer"></div>
  </div>

  <!-- 5. Pricing & Commercial Terms -->
  <div class="form-section">
    <h2>5. Pricing & Commercial Terms</h2>
    <label>Incoterm</label><select name="incoterm"><option>FOB</option><option>CIF</option><option>EXW</option></select>
    <label>Unit Price</label><input type="number" name="unitPrice" step="0.01" />
    <label>MOQ</label><input type="text" name="moq" />
  </div>

  <!-- 6. Logistics & Export Readiness -->
  <div class="form-section">
    <h2>6. Logistics & Export Readiness</h2>
    <label>Port of Loading</label><input type="text" name="portLoading" />
    <label>Lead Time (days)</label><input type="number" name="leadTime" />
  </div>

  <!-- 7. Sustainability & CSR -->
  <div class="form-section">
    <h2>7. Sustainability & CSR</h2>
    <label>Environmental Policy</label><textarea name="envPolicy"></textarea>
    <label>Social Audits</label><input type="text" name="socialAudit" />
  </div>

  <!-- 8. References & Samples -->
  <div class="form-section">
    <h2>8. References & Samples</h2>
    <label>Key Clients</label><textarea name="keyClients"></textarea>
    <label>Sample Availability</label><input type="text" name="sampleAvailability" />
    <label>Datasheet Link</label><input type="url" name="datasheetLink" />
  </div>

  <button type="submit">Submit Profile</button>

  <script>
    // Load HS code tree from back-end
    let hsTree = [];
    fetch('/api/hs-codes')
      .then(r => r.json())
      .then(tree => {
        hsTree = tree;
        // Populate existing product blocks
        for (let i = 0; i < productCount; i++) populateChapter(i);
      });

    // Populate chapter select for a given product index
    function populateChapter(idx) {
      const sel = document.getElementById(`chapter_${idx}`);
      if (!sel) return;
      sel.innerHTML = '<option value="">Select chapter…</option>' +
        hsTree.map(ch => `<option value="${ch.chapter}">Ch ${ch.chapter}: ${ch.title}</option>`).join('');
    }

    // Existing script continues...
    // Data definitions
    const subcategories = {
      grains: { Wheat: '1001.10', Maize: '1005.90', Rice: '1006.30', Barley: '1003.00' },
      fruits: { Citrus: '0805.50', Berries: '0810.10', 'Leafy Greens': '0706.10', 'Root Vegetables': '0701.90' },
      driedFruits: { Raisins: '0806.20', Figs: '0804.20', Almonds: '0802.12', Pistachios: '0802.51' },
      oils: { 'Sunflower Oil': '1512.11', 'Olive Oil': '1509.10', 'Palm Oil': '1511.10' },
      cacao: { 'Cocoa Beans': '1801.00', 'Cocoa Liquor': '1803.00', 'Green Coffee': '0901.11', 'Roasted Coffee': '0901.21' },
      spices: { Pepper: '0904.11', Turmeric: '0910.10', Cinnamon: '0906.10', Cloves: '0907.10' },
      flowers: { Roses: '0603.11', Lilies: '0603.12', Orchids: '0603.19', Tulips: '0603.13' }
    };

    // Site Repeater
    let siteCount = 0;
    function addSite() {
      const idx = siteCount++;
      const container = document.getElementById('sitesContainer');
      const block = document.createElement('div');
      block.className = 'block';
      block.innerHTML = `
        <span class='remove-btn' onclick='this.parentNode.remove()'>✖</span>
        <label>Site Type</label><input type='text' name='sites[${idx}][type]' required />
        <label>Address</label><textarea name='sites[${idx}][address]' required></textarea>
      `;
      container.appendChild(block);
    }

    // Product Repeater
    let productCount = 0;
    function addProduct() {
      const idx = productCount++;
      const container = document.getElementById('productsContainer');
      const block = document.createElement('div');
      block.className = 'block';
      block.innerHTML = `
        <span class='remove-btn' onclick='this.parentNode.remove()'>✖</span>
        <label>Category</label>
        <label>HS Chapter</label>
        <select id='chapter_${idx}' name='products[${idx}][hsChapter]' onchange='onChapterChange(${idx}, this.value)'><option value=''>Select chapter…</option></select>
        <label>HS Heading</label>
        <select id='heading_${idx}' name='products[${idx}][hsHeading]' onchange='onHeadingChange(${idx}, this.value)'><option value=''>Select heading…</option></select>
        <label>HS Code</label>
        <select id='code_${idx}' name='products[${idx}][hsCode]'><option value=''>Select code…</option></select>[${idx}][category]' onchange='onCategoryChange(${idx}, this.value)'>
          <option value=''>Select...</option>
          ${Object.keys(subcategories).map(cat => `<option value='${cat}'>${cat}</option>`).join('')}
        </select>
        <label>Subcategory</label>
        <select id='sub_${idx}' name='products[${idx}][subcategory]'><option value=''>Select...</option></select>
        <label>Variant (optional)</label>
        <input type='text' name='products[${idx}][variant]' placeholder='e.g. Winter, Durum, Red' />
        <label>HS Code</label>
        <input type='text' id='hs_${idx}' name='products[${idx}][hsCode]' readonly />
        <div class='dynamic-params hidden' id='params_${idx}'></div>
        <label>Other Product Name</label>
        <input type='text' name='products[${idx}][customName]' placeholder='Optional custom name' />
        <label>Product Photos</label>
        <input type='file' name='products[${idx}][photos][]' multiple accept='image/*' />
      `;
      container.appendChild(block);
    }

    function onCategoryChange(idx, category) {
      const subSel = document.getElementById(`sub_${idx}`);
      subSel.innerHTML = `<option value=''>Select...</option>` +
        Object.keys(subcategories[category] || {}).map(s => `<option value='${s}'>${s}</option>`).join('');
      document.getElementById(`hs_${idx}`).value = '';
      document.getElementById(`params_${idx}`).classList.add('hidden');
    }

    function onSubcategoryChange(idx) {
      const category = document.querySelector(`[name='products[${idx}][category]']`).value;
      const sub = document.getElementById(`sub_${idx}`).value;
      document.getElementById(`hs_${idx}`).value = subcategories[category][sub] || '';
      showParams(idx, category);
    }

    function showParams(idx, category) {
      const container = document.getElementById(`params_${idx}`);
      container.innerHTML = '';
      if (category === 'grains') {
        container.innerHTML = `
          <label>Moisture (%)</label><input type='number' name='products[${idx}][moisture]' min='0' max='20' step='0.1' />
          <label>Protein (%)</label><input type='number' name='products[${idx}][protein]' min='5' max='15' step='0.1' />
        `;
      } else if (category === 'fruits') {
        container.innerHTML = `
          <label>Brix (°)</label><input type='number' name='products[${idx}][brix]' min='0' max='30' step='0.1' />
          <label>Firmness (N)</label><input type='number' name='products[${idx}][firmness]' />
        `;
      }
      // add other categories similarly...
      container.classList.remove('hidden');
    }

    // Certification Repeater
    let certCount = 0;
    function addCert() {
      const idx = certCount++;
      const container = document.getElementById('certsContainer');
      const block = document.createElement('div');
      block.className = 'block';
      block.innerHTML = `
        <span class='remove-btn' onclick='this.parentNode.remove()'>✖</span>
        <label>Certification Name</label><input type='text' name='certs[${idx}][name]' required />
        <label>Issuing Authority</label><input type='text' name='certs[${idx}][authority]' required />
        <label>Registration Number</label><input type='text' name='certs[${idx}][regNo]' />
        <label>Valid From</label><input type='date' name='certs[${idx}][from]' />
        <label>Valid To</label><input type='date' name='certs[${idx}][to]' />
        <label>Description</label><textarea name='certs[${idx}][description]'></textarea>
      `;
      container.appendChild(block);
    }

    // Initialize
    addSite();
    addProduct();
    addCert();

    // Listen for subcategory change events dynamically
    document.addEventListener('change', e => {
      if (e.target && e.target.id.startsWith('sub_')) {
        const idx = e.target.id.split('_')[1];
        onSubcategoryChange(idx);
      }
    });
  </script>
</body>
</html>
